#
# Copyright Golden Delicious Computers GmbH&Co. KG, 2010-2013
# licenced unter GPL 2.0
#
# this is part of OM Beagle Hybrid / GTA04
# it is derived from http://elinux.org/BeagleBoardDebian
#
# run this script to install/update the packages by some useful tools
#

apt-get update	# get latest package list
yes | dpkg --configure -a	# try to cleanup if previous attempt failed
apt-get install -y --force-yes debian-archive-keyring
apt-get update		# get latest package list again
apt-get install -y apt-utils

#
# install useful command line tools
#

USEFUL="ntp"	# update clock from network
USEFUL+="sudo"			# always nice to have...
USEFUL+="udev"			# important
USEFUL+="dnsutils"     # nslookup etc.
USEFUL+="dhcpcd"		# so that we can get an IP address from the access point
USEFUL+="mtd-utils"    # read/write/erase NAND
USEFUL+="uboot-envtools"	# read write U-Boot environment e.g. to trigger boot to boot-menu or reflash
USEFUL+="i2c-tools"    # read/write/scan I2C
USEFUL+="alsa-utils"   # alsamixer, aplay etc.
USEFUL+="fbset"       # to switch to TV-Out
USEFUL+="usbmount"
USEFUL+="evtest"       # allows to check touch screen, keyboard and button events
USEFUL+="joystick"
USEFUL+="openssh-server openssh-client"    # remote access thorugh ssh
USEFUL+="ppp"
USEFUL+="libertas-firmware wireless-tools" # driver for Marvell WLAN
USEFUL+="bluez-utils bluez-audio"          # driver for HCI Bluetooth
USEFUL+="rfkill"
USEFUL+="dosfstools parted"	# to make bootable SD cards
USEFUL+="man-db"		# some tools install a manual anyways - so why not make them readable
USEFUL+="libc6-dev linux-libc-dev make"		# so that we can cc some (simple) binaries from source
USEFUL+="iptables"	isc-dhcp-server	# for WWAN <-> USB <-> WLAN tethering

apt-get install -y $USEFUL
apt-get install -y --force-yes media-ctl	# for camera isp control

#
# install X11 driver for omap3
#

apt-get install -y xorg

case "$(cat /etc/debian_version)" in
6.* | 7.* )	# Squeeze touch screen support

apt-get install -y xserver-xorg-video-omap3 xserver-xorg-input-tslib xserver-xorg-input-void libts-bin

# Kernels newer than 2.6.37 use a different EV_VERSION

case "$(uname -r)" in
2.6.37 | 2.6.38 | 2.6.39 | 3.* )
	wget http://download.goldelico.com/gta04/debian/dists/stable/main/binary-armel/libts-0.0-0_1.0-8lindi1_armel.deb
	dpkg -i libts-0.0-0_1.0-8lindi1_armel.deb
	;;
esac

;;
7.* )	# Wheezy touch screen support

apt-get install -y xserver-xorg-video-omap3 xserver-xorg-input-tslib xserver-xorg-input-void libts-bin

;;

5.* )	# Lenny needs a backport
#
# backport touch screen driver to fix http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=493942
# see (German): http://wiki.unixboard.de/index.php/Debian_Backports
#

wget -c http://rcn-ee.homeip.net:81/dl/deb-sbuild/lenny/xorg-drivers/xserver-xorg-video-omap3_0.1.1-2_armel.deb
dpkg -i xserver-xorg-video-omap3_0.1.1-2_armel.deb

apt-get install -y build-essential dpkg-dev debhelper xserver-xorg-dev libts-dev pkg-config

wget http://ftp.debian.org/debian/pool/main/x/xf86-input-tslib/xf86-input-tslib_0.0.4-5.dsc
wget http://ftp.debian.org/debian/pool/main/x/xf86-input-tslib/xf86-input-tslib_0.0.4-5.diff.gz
wget http://ftp.debian.org/debian/pool/main/x/xf86-input-tslib/xf86-input-tslib_0.0.4.orig.tar.gz
dpkg-source -x xf86-input-tslib_0.0.4-5.dsc
( 
cd xf86-input-tslib-0.0.4
dpkg-checkbuilddeps
### apply our patch ###
cp ../tslib.c src/tslib.c
dpkg-buildpackage
)

# note: removing dpkg-dev will also remove usb-modeswitch !?!

apt-get remove -y build-essential debhelper xserver-xorg-dev libts-dev pkg-config
rm -rf xf86-input-tslib_0.0.4* xf86-input-tslib-0.0.4
dpkg -i xserver-xorg-input-tslib_0.0.4-5_armel.deb

apt-get install -y libts-bin

;;
* )
echo "unknown Debian Version: $(cat /etc/debian_version)"
;;
esac

#
# install GUI components
#

# apt-get install -y gnome-core gdm
# apt-get install -y kde-core kdm
# apt-get install -y gdm
# apt-get install -y xfce4
# apt-get install -y matchbox
# apt-get install -y quantumstep quantumstep-displaymanager

apt-get install -y lxde

#
# applications, tools and games
#

apt-get install -y gpsd dbus-x11 tangogps synaptic matchbox-keyboard matchbox-keyboard-im

#
# cleanup
#

apt-get -y autoremove
apt-get -y autoclean
rm -f *.deb

#
# reinstall our private configuration (apt-get install may have overwritten some parts)
#

(cd / && tar xvzf /root/config.tgz)

# (re) calibrate touch screen
# ts_calibrate

echo useful packages installed and configured.
