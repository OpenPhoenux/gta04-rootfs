#
# dial a phone number
#
# usage: dial number
# to hang up: dial -

make femtocom

for repeat in 1 2 3 4 5
	do
	if lsusb | fgrep '0af0:8800 Option' >/dev/null
		then # found
		break
	fi
	if [ -w /sys/devices/virtual/gpio/gpio186/value ]
	then # wake up modem in GTA04A4
		echo 1 >/sys/devices/virtual/gpio/gpio186/value
		sleep 1
		echo 0 >/sys/devices/virtual/gpio/gpio186/value
		sleep 5
	fi
	done

for i in $(cd /sys/class/tty/ && echo ttyHS*)
	do
	if [ "$(cat /sys/class/tty/$i/hsotype)" == "Application" ]
		then
		IF="/dev/$i"
	fi
done

[ "$IF" ] || (echo HSO Application interface not found; exit 1)

echo Interface: $IF
killall arecord

# enable phone mixer (in software routing mode even on GTA04A4 boards)
amixer set 'AVADC Clock Priority' 'HiFi high priority'
amixer set 'DAC1 Analog' off
amixer set 'DAC2 Analog' on
#amixer set  'Codec Operation Mode' 'Option 1 (audio)'
amixer set  'Codec Operation Mode' 'Option 2 (voice/audio)'
amixer set Earpiece 100%
amixer set 'Earpiece Mixer AudioL2' on
#amixer set 'Earpiece Mixer AudioR2' off # does not exist
amixer set 'Earpiece Mixer Voice' off
amixer set 'Analog' 5
amixer set TX1 'Analog'
amixer set 'TX1 Digital' 12
amixer set 'Analog Left AUXL' nocap
amixer set 'Analog Right AUXR' nocap
amixer set 'Analog Left Main Mic' cap
amixer set 'Analog Left Headset Mic' nocap

(
if [ "$1" == "-" ]
then
	echo "AT+CHUP"; sleep 3
else
	echo "AT_ODO=0"; sleep 1
	echo "AT_OPCMENABLE=1"; sleep 1
	echo "AT_OPCMPROF=0"; sleep 1
	echo "AT+COPS"; sleep 1
	echo "ATD$1;"; sleep 1
	arecord -fS16_LE -r8000 | aplay -Ddefault:CARD=gta04voice &	# microphone -> modem
	arecord -Ddefault:CARD=gta04voice -fS16_LE -r8000 | aplay	# modem -> earpiece, speaker, headset
fi
) | ./femtocom $IF
